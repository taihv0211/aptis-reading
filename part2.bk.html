<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luy·ªán t·∫≠p s·∫Øp x·∫øp th·ª© t·ª±</title>
  <style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --primary:#667eea;
      --primaryHover:#5563d6;
      --ok:#38b2ac;
      --bad:#e53e3e;
      --card:#ffffff;
      --muted:#6b7280;
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      margin: 0;
      padding: 28px;
      color:#111827;
    }

    .container {
      max-width: 920px;
      margin: auto;
      background: var(--card);
      padding: 26px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.18);
      animation: fadeIn 0.35s ease;
    }

    h1, h2 {
      text-align: center;
      margin: 0 0 14px;
      letter-spacing: 0.2px;
    }

    .sub {
      text-align:center;
      color: var(--muted);
      margin: 0 0 18px;
    }

    .topbar {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f6f7ff;
      border: 1px solid #e5e7eb;
      margin-bottom: 18px;
    }

    .badge {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef0ff;
      border: 1px solid #dfe3ff;
      color: #2d37a3;
      white-space: nowrap;
    }

    .status {
      font-size: 13px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    button {
      padding: 10px 16px;
      margin: 6px 6px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 18px rgba(102,126,234,0.18);
    }

    button:hover {
      background: var(--primaryHover);
      transform: translateY(-1px);
    }

    button:disabled {
      background: #a9b2ff;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.85;
    }

    .btn-secondary {
      background: #111827;
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }

    .btn-secondary:hover { background:#0b1220; }

    .actions {
      text-align: center;
      margin-top: 22px;
    }

    .panel {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 18px;
      background: #ffffff;
    }

    /* Larger spacing between the answer items */
    #choices {
      margin-top: 14px;
    }

    .choice {
      padding: 14px 16px;
      border: 2px dashed #c7c9ff;
      border-radius: 12px;
      margin: 18px 0; /* more spacing */
      background: #f9f9ff;
      cursor: grab;
      font-size: 16px;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      user-select: none;
    }

    .choice:hover {
      background: #f1f3ff;
    }

    /* Clear drag feedback */
    .choice.dragging {
      cursor: grabbing;
      transform: scale(1.03);
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
      background: #eef0ff;
      opacity: 0.78;
      border-color: #8b97ff;
    }

    .choice.drag-over {
      border-color: var(--primary);
      background: #eef0ff;
      box-shadow: inset 0 0 0 2px rgba(102,126,234,0.2);
    }

    .correct {
      background: #e6fffa !important;
      border-color: var(--ok) !important;
      color: #065f5b;
    }

    .wrong {
      background: #ffe6e6 !important;
      border-color: var(--bad) !important;
      color: #742a2a;
    }

    .hidden { display: none; }

    #wrongList > div {
      background: #fafafa;
      border-left: 6px solid var(--bad);
      padding: 12px;
      margin: 12px 0;
      border-radius: 10px;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
    }

    .error {
      margin: 14px 0 0;
      padding: 12px;
      border-radius: 12px;
      background: #fff1f2;
      border: 1px solid #fecdd3;
      color: #9f1239;
      font-size: 14px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- INDEX PAGE -->
  <div id="indexPage">
    <h1>üß† Luy·ªán t·∫≠p s·∫Øp x·∫øp th·ª© t·ª±</h1>
    <p class="sub">Ch·ªçn ch·∫ø ƒë·ªô l√†m b√†i</p>

    <div class="panel">
      <div class="actions" style="margin-top:0">
        <button id="btnStartRandom" onclick="startQuiz('random')" disabled>üîÄ Random c√¢u h·ªèi</button>
        <button id="btnStartOrder" onclick="startQuiz('order')" disabled>‚û°Ô∏è L·∫ßn l∆∞·ª£t</button>
      </div>
      <div class="hint">(G·ª£i √Ω: m·ªü b·∫±ng server local ƒë·ªÉ load <b>questions.json</b>. V√≠ d·ª•: <code>python -m http.server 5500</code>)</div>
      <div id="loadError" class="error hidden"></div>
    </div>
  </div>

  <!-- QUIZ PAGE -->
  <div id="quizPage" class="hidden">
    <div class="topbar">
      <div class="badge" id="progressBadge">C√¢u 1/1</div>
      <div class="status" id="modeText">Mode: -</div>
    </div>

    <div class="panel">
      <h2 id="questionTitle"></h2>
      <div id="choices"></div>
      <div class="actions">
        <button id="btnCheck" onclick="checkAnswer()">‚úÖ Check ƒë√°p √°n</button>
        <button id="btnNext" class="btn-secondary" onclick="nextQuestion()">‚û°Ô∏è Next</button>
      </div>
      <div class="hint">K√©o-th·∫£ c√°c ƒë√°p √°n ƒë·ªÉ s·∫Øp x·∫øp ƒë√∫ng th·ª© t·ª±.</div>
    </div>
  </div>

  <!-- RESULT PAGE -->
  <div id="resultPage" class="hidden">
    <h2>üìä K·∫øt qu·∫£</h2>
    <p id="summary" style="text-align:center;font-size:16px;margin: 6px 0 16px"></p>
    <div id="wrongList"></div>
    <div class="actions">
      <button class="btn-secondary" onclick="goHome()">üè† Quay l·∫°i trang index</button>
    </div>
  </div>

</div>

<script>
  // =============================
  // State
  // =============================
  let questions = [];
  let mode = 'order';
  let currentIndex = 0;
  let quizList = [];
  let userResults = []; // {question, isCorrect, correctOrder, userOrder}
  let hasChecked = false;

  // =============================
  // Helpers
  // =============================
  function shuffleCopy(arr) {
    // Fisher-Yates for predictable correctness
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function setVisible(id, visible) {
    const el = document.getElementById(id);
    el.classList.toggle('hidden', !visible);
  }

  function setLoadError(message) {
    const el = document.getElementById('loadError');
    if (!message) {
      el.classList.add('hidden');
      el.innerText = '';
      return;
    }
    el.classList.remove('hidden');
    el.innerText = message;
  }

  function getCurrentUserOrder() {
    return Array.from(document.querySelectorAll('.choice')).map(c => c.dataset.value);
  }

  function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    for (let i = 0; i < a.length; i++) {
      if (a[i] !== b[i]) return false;
    }
    return true;
  }

  // =============================
  // Load JSON
  // =============================
  async function loadQuestions() {
    try {
      setLoadError('');
      const res = await fetch('questions.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        throw new Error('questions.json ph·∫£i l√† m·ªôt m·∫£ng v√† kh√¥ng ƒë∆∞·ª£c r·ªóng.');
      }

      // Minimal validation
      for (const q of data) {
        if (!q || typeof q.question !== 'string' || !Array.isArray(q.options) || !Array.isArray(q.answer)) {
          throw new Error('M·ªôt s·ªë c√¢u h·ªèi thi·∫øu field: question/options/answer.');
        }
        if (q.options.length !== 5 || q.answer.length !== 5) {
          throw new Error('M·ªói c√¢u ph·∫£i c√≥ ƒë√∫ng 5 options v√† 5 answer.');
        }
      }

      questions = data;
      document.getElementById('btnStartRandom').disabled = false;
      document.getElementById('btnStartOrder').disabled = false;
      document.getElementById('modeText').innerText = 'Mode: -';
    } catch (err) {
      // Common case: opened from file:// (CORS) or missing server
      setLoadError(
        `Kh√¥ng load ƒë∆∞·ª£c questions.json (${String(err.message || err)}).\n` +
        `B·∫°n h√£y ch·∫°y b·∫±ng server local (vd: python -m http.server 5500) r·ªìi m·ªü http://localhost:5500/`
      );
      document.getElementById('btnStartRandom').disabled = true;
      document.getElementById('btnStartOrder').disabled = true;
    }
  }

  // =============================
  // Quiz flow
  // =============================
  function startQuiz(selectedMode) {
    // Ensure loaded
    if (!questions || questions.length === 0) {
      setLoadError('Ch∆∞a load ƒë∆∞·ª£c questions.json. Vui l√≤ng ch·∫°y b·∫±ng server local.');
      return;
    }

    mode = selectedMode;
    quizList = [...questions];
    if (mode === 'random') {
      quizList = shuffleCopy(quizList);
    }

    currentIndex = 0;
    userResults = [];
    hasChecked = false;

    setVisible('indexPage', false);
    setVisible('resultPage', false);
    setVisible('quizPage', true);

    document.getElementById('modeText').innerText = `Mode: ${mode === 'random' ? 'Random' : 'L·∫ßn l∆∞·ª£t'}`;

    loadQuestion();
  }

  function loadQuestion() {
    const q = quizList[currentIndex];
    document.getElementById('progressBadge').innerText = `C√¢u ${currentIndex + 1}/${quizList.length}`;
    document.getElementById('questionTitle').innerText = q.question;

    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = '';

    // Randomize the displayed order every time
    const randomizedOptions = shuffleCopy(q.options);

    for (const opt of randomizedOptions) {
      const div = document.createElement('div');
      div.className = 'choice';
      div.draggable = true;
      // Use dataset to avoid corrupting values when we append "(ƒê√∫ng: ...)"
      div.dataset.value = opt;
      div.innerText = opt;
      addDragAndDrop(div);
      choicesDiv.appendChild(div);
    }

    // Reset state per question
    hasChecked = false;
    document.getElementById('btnCheck').disabled = false;
  }

  // Drag & drop (swap text + dataset)
  let dragSrc = null;
  function addDragAndDrop(el) {
    el.addEventListener('dragstart', () => {
      dragSrc = el;
      el.classList.add('dragging');
    });

    el.addEventListener('dragend', () => {
      el.classList.remove('dragging');
    });

    el.addEventListener('dragover', (e) => {
      e.preventDefault();
      el.classList.add('drag-over');
    });

    el.addEventListener('dragleave', () => {
      el.classList.remove('drag-over');
    });

    el.addEventListener('drop', (e) => {
      e.preventDefault();
      el.classList.remove('drag-over');
      if (!dragSrc || dragSrc === el) return;

      const tmpText = dragSrc.innerText;
      const tmpVal = dragSrc.dataset.value;

      dragSrc.innerText = el.innerText;
      dragSrc.dataset.value = el.dataset.value;

      el.innerText = tmpText;
      el.dataset.value = tmpVal;
    });
  }

  function recordAnswerIfNeeded() {
    // Avoid double recording if user clicks Check multiple times
    if (hasChecked) return;

    const q = quizList[currentIndex];
    const userOrder = getCurrentUserOrder();
    const isCorrect = arraysEqual(userOrder, q.answer);

    userResults.push({
      question: q.question,
      isCorrect,
      correctOrder: [...q.answer],
      userOrder
    });

    hasChecked = true;
  }

  function checkAnswer() {
    recordAnswerIfNeeded();

    const q = quizList[currentIndex];
    const choices = Array.from(document.querySelectorAll('.choice'));
    const userOrder = getCurrentUserOrder();

    // Paint UI with per-position feedback
    for (let i = 0; i < choices.length; i++) {
      const itemVal = userOrder[i];
      const correctVal = q.answer[i];

      choices[i].classList.remove('correct', 'wrong');
      choices[i].innerText = itemVal; // reset visible label

      if (itemVal === correctVal) {
        choices[i].classList.add('correct');
      } else {
        choices[i].classList.add('wrong');
        // show correct at this position
        choices[i].innerText = `${itemVal}  (ƒê√∫ng: ${correctVal})`;
      }
    }

    // Prevent recording multiple times
    document.getElementById('btnCheck').disabled = true;
  }

  function nextQuestion() {
    // If user didn't click check, auto-record result silently
    recordAnswerIfNeeded();

    currentIndex++;
    if (currentIndex >= quizList.length) {
      showResult();
    } else {
      loadQuestion();
    }
  }

  function showResult() {
    setVisible('quizPage', false);
    setVisible('resultPage', true);

    const correct = userResults.filter(r => r.isCorrect).length;
    const wrong = userResults.length - correct;
    document.getElementById('summary').innerText = `‚úÖ ƒê√∫ng: ${correct} | ‚ùå Sai: ${wrong}`;

    const wrongList = document.getElementById('wrongList');
    wrongList.innerHTML = '';

    if (wrong === 0) {
      wrongList.innerHTML = '<div style="border-left:6px solid var(--ok);background:#f0fdfa;padding:12px;border-radius:10px">üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ ƒë√∫ng t·∫•t c·∫£ c√¢u.</div>';
      return;
    }

    const header = document.createElement('h3');
    header.innerText = '‚ùå C√°c c√¢u l√†m sai';
    wrongList.appendChild(header);

    userResults.filter(r => !r.isCorrect).forEach(r => {
      const div = document.createElement('div');
      div.innerHTML = `
        <b>${r.question}</b><br/>
        <div style="margin-top:6px"><b>ƒê√°p √°n ƒë√∫ng:</b> ${r.correctOrder.join(' ‚Üí ')}</div>
        <div style="margin-top:6px"><b>B·∫°n ch·ªçn:</b> ${r.userOrder.join(' ‚Üí ')}</div>
      `;
      wrongList.appendChild(div);
    });
  }

  function goHome() {
    setVisible('resultPage', false);
    setVisible('quizPage', false);
    setVisible('indexPage', true);
    document.getElementById('modeText').innerText = 'Mode: -';
  }

  // =============================
  // Lightweight self-tests (console)
  // =============================
  function runSelfTests() {
    try {
      // Test arraysEqual
      console.assert(arraysEqual([1,2,3],[1,2,3]) === true, 'arraysEqual true case failed');
      console.assert(arraysEqual([1,2,3],[1,2,4]) === false, 'arraysEqual false case failed');

      // Test shuffleCopy length preservation
      const s = shuffleCopy([1,2,3,4,5]);
      console.assert(s.length === 5, 'shuffleCopy length failed');
      console.assert(new Set(s).size === 5, 'shuffleCopy uniqueness failed');

      console.log('Self-tests: OK');
    } catch (e) {
      console.warn('Self-tests: FAILED', e);
    }
  }

  // Load at startup
  runSelfTests();
  loadQuestions();
</script>
</body>
</html>
